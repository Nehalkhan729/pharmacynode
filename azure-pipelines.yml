trigger:
- main  # Replace 'main' with your branch name

pool:
  name: 'Default'  # Specify the Default agent pool name

variables:
  ACR_NAME: 'aksrg'  # Replace with your ACR name (without .azurecr.io)
  IMAGE_NAME: 'pharma'
  TAG: $(Build.BuildId)  # Use build ID for tagging images

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Node.js Docker Image'
  jobs:
  - job: Build
    displayName: 'Build and Push Job'
    steps:
      # Step 1: Checkout source code
      - task: Checkout@1

      # Step 2: Set up Node.js environment
      - task: UseNode@1
        inputs:
          version: '16.x'  # Specify the required Node.js version

      # Step 3: Install dependencies and build project
      - script: |
          npm install
          npm run build
        displayName: 'Install dependencies and build'

      # Step 4: Build and Push Docker image to ACR
      - task: Docker@2
        displayName: 'Build and Push Docker Image'
        inputs:
          command: buildAndPush
          containerRegistry: 'Acrserverconnection'  # Replace with your Azure service connection name
          repository: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME)'
          Dockerfile: 'Dockerfile'  # Ensure the correct path if not in the root folder
          tags: |
            $(TAG)
            latest
