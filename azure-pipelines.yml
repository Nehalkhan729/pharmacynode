jobs:
  - job: Build
    displayName: 'Build and Push Node.js Docker Image'
    pool:
      name: 'Default'

    variables:
      # Replace with your ACR name (without .azurecr.io)
      ACR_NAME: 'aksrg'
      IMAGE_NAME: 'pharma'
      TAG: $(Build.BuildId)  # Use build ID for tagging images

    steps:
      # Step 1: Checkout code
      - task: Checkout@1

      # Step 2: Set up Node.js
      - task: UseNode@1
        inputs:
          version: '16.x'  # Specify Node.js version

      # Step 3: Install dependencies and build
      - script: |
          npm install
          npm run build
        displayName: 'Install dependencies and build'

      # Step 4: Log in to Azure Container Registry
      - task: Docker@2
        inputs:
          command: login
          containerRegistry: 'acr-serviceconnection'  # Your ACR service connection name

      # Step 5: Build Docker image
      - task: Docker@2
        inputs:
          command: build
          containerRegistry: 'acr-serviceconnection'
          repository: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME)'  # Correct ACR repository path
          Dockerfile: 'Dockerfile'  # Ensure this path is correct if your Dockerfile is in a subfolder
          tags: |
            $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(TAG)
            $(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest

      # Step 6: Push Docker image to ACR
      - task: Docker@2
        inputs:
          command: push
          containerRegistry: 'acr-serviceconnection'
          tags: |
            $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(TAG)
            $(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest
